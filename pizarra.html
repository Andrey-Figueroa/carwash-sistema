<!doctype html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pizarra CarWash ‚Äî Vista del Local</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090d;--surface:#0d1219;--card:#111a25;--border:#1a2a3a;
  --accent:#00d4ff;--green:#00e676;--yellow:#ffc107;--red:#ff5252;
  --text:#dff0ff;--muted:#4a6a85;
}
body{background:var(--bg);font-family:"DM Sans",sans-serif;color:var(--text);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden}
body::before{content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.025) 2px,rgba(0,0,0,0.025) 4px);pointer-events:none;z-index:9999}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:linear-gradient(90deg,#050d14,#081525);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.topbar-left{display:flex;align-items:center;gap:14px}
.logo-chip{background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.25);border-radius:8px;padding:6px 14px;font-family:"Bebas Neue",sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent)}
.page-title{font-family:"Bebas Neue",sans-serif;font-size:26px;letter-spacing:3px;background:linear-gradient(90deg,#fff 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.topbar-right{display:flex;align-items:center;gap:12px}
.status-pill{display:flex;align-items:center;gap:7px;font-size:12px;color:var(--muted);background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:20px;padding:5px 12px}
.pulse-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,230,118,0.5)}50%{box-shadow:0 0 0 5px rgba(0,230,118,0)}}
.topbar-btn{background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.2);color:var(--accent);border-radius:8px;padding:7px 14px;cursor:pointer;font-size:13px;font-family:inherit;transition:all .2s;display:flex;align-items:center;gap:6px;text-decoration:none}
.topbar-btn:hover{background:rgba(0,212,255,0.15);border-color:var(--accent)}
.back-btn{background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:7px 14px;cursor:pointer;font-size:13px;font-family:inherit;transition:all .2s;text-decoration:none;display:flex;align-items:center;gap:6px}
.back-btn:hover{color:var(--text);border-color:var(--muted)}

/* STATS */
.stats-bar{display:flex;border-bottom:1px solid var(--border);background:var(--surface)}
.stat{flex:1;padding:14px 20px;border-right:1px solid var(--border);display:flex;align-items:center;gap:12px}
.stat:last-child{border-right:none}
.stat-ico{font-size:22px}
.stat-val{font-size:24px;font-weight:700;font-family:"DM Mono",monospace}
.stat-lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:1px}

/* BOARD ‚Äî 3 cols */
.board{display:grid;grid-template-columns:1fr 1fr 1fr;flex:1;gap:0;min-height:calc(100vh - 130px)}

/* ZONES */
.zone{position:relative;border:1px solid var(--border);padding:22px;overflow:hidden;min-height:400px}
.zone::before{content:"";position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,0.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.015) 1px,transparent 1px);background-size:44px 44px;pointer-events:none}
.zone-label{display:flex;align-items:center;gap:10px;margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--border);position:relative;z-index:1}
.zone-title{font-family:"Bebas Neue",sans-serif;font-size:20px;letter-spacing:2px}
.zone-count{margin-left:auto;font-family:"DM Mono",monospace;font-size:13px;color:var(--muted);background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:6px;padding:2px 10px}

.zone-proceso{background:radial-gradient(ellipse at 10% 90%,rgba(0,100,180,0.1) 0%,transparent 60%),#080f18}
.zone-proceso .zone-title{color:#4fc3f7}
.zone-terminado{background:radial-gradient(ellipse at 50% 20%,rgba(0,180,80,0.08) 0%,transparent 60%),#08130e}
.zone-terminado .zone-title{color:var(--green)}
.zone-retirado{background:radial-gradient(ellipse at 90% 90%,rgba(255,82,82,0.06) 0%,transparent 60%),#110a0a;opacity:.75}
.zone-retirado .zone-title{color:var(--red)}

/* CARS GRID */
.cars-grid{display:flex;flex-wrap:wrap;gap:14px;align-content:flex-start;position:relative;z-index:1}

/* CAR CARD */
.car-card{position:relative;width:172px;background:rgba(0,0,0,0.45);border-radius:18px;border:1px solid rgba(255,255,255,0.06);padding:14px;transition:transform .2s,border-color .2s,box-shadow .2s;animation:carIn .42s cubic-bezier(.34,1.56,.64,1) forwards}
.car-card:hover{transform:translateY(-4px);border-color:rgba(255,255,255,0.14);box-shadow:0 12px 30px rgba(0,0,0,0.4)}
@keyframes carIn{from{opacity:0;transform:scale(.82) translateY(12px)}to{opacity:1;transform:scale(1) translateY(0)}}

.zone-proceso .car-card::after{content:"";position:absolute;inset:0;border-radius:18px;background:linear-gradient(135deg,rgba(0,180,255,0.05),transparent 60%);animation:shimmer 2.5s ease-in-out infinite alternate;pointer-events:none}
@keyframes shimmer{from{opacity:.2}to{opacity:.8}}
.zone-terminado .car-card{border-color:rgba(0,230,118,0.14)}
.zone-terminado .car-card::before{content:"";position:absolute;bottom:-1px;left:10%;width:80%;height:2px;background:linear-gradient(90deg,transparent,rgba(0,230,118,0.35),transparent);border-radius:2px}
.zone-retirado .car-card{opacity:.5;filter:grayscale(60%)}

/* Wash drops */
.wash-drops{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;border-radius:18px;overflow:hidden}
.drop-p{position:absolute;width:2px;border-radius:10px;background:linear-gradient(to bottom,transparent,rgba(0,200,255,0.65));animation:dfall linear infinite}
@keyframes dfall{0%{transform:translateY(-8px);opacity:0}10%{opacity:1}100%{transform:translateY(110px);opacity:0}}

/* CAR SVG */
.car-visual{width:100%;height:80px;display:flex;align-items:center;justify-content:center;margin-bottom:10px}
.car-svg{filter:drop-shadow(0 5px 10px rgba(0,0,0,0.5));transition:transform .3s}
.car-card:hover .car-svg{transform:scale(1.07)}

/* INFO */
.car-plate{font-family:"DM Mono",monospace;font-size:13px;font-weight:500;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:3px 8px;text-align:center;letter-spacing:2px;margin-bottom:6px}
.car-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px}
.car-service{font-size:10px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.car-time{font-size:10px;color:var(--muted);font-family:"DM Mono",monospace;margin-top:6px;display:flex;align-items:center;gap:4px}
.car-time.urgent{color:var(--red)}.car-time.warn{color:var(--yellow)}

/* BADGE */
.car-badge{position:absolute;top:9px;right:9px;font-size:9px;font-weight:700;padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:.5px}
.badge-proceso{background:rgba(0,180,255,0.15);color:#4fc3f7;border:1px solid rgba(0,180,255,0.25)}
.badge-terminado{background:rgba(0,230,118,0.12);color:#00e676;border:1px solid rgba(0,230,118,0.2)}
.badge-retirado{background:rgba(255,82,82,0.1);color:#ff7070;border:1px solid rgba(255,82,82,0.2)}

/* BUTTONS */
.card-actions{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.btn-action{width:100%;border-radius:9px;padding:7px 8px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;border:1px solid transparent;display:flex;align-items:center;justify-content:center;gap:5px}
.btn-terminar{background:rgba(0,212,255,0.1);border-color:rgba(0,212,255,0.25);color:var(--accent)}
.btn-terminar:hover{background:rgba(0,212,255,0.22);transform:scale(1.02)}
.btn-avisar{background:rgba(0,230,118,0.1);border-color:rgba(0,230,118,0.2);color:#00e676}
.btn-avisar:hover{background:rgba(0,230,118,0.2);transform:scale(1.02)}
.btn-retirar{background:rgba(255,82,82,0.08);border-color:rgba(255,82,82,0.2);color:#ff7070}
.btn-retirar:hover{background:rgba(255,82,82,0.18);transform:scale(1.02)}

/* EMPTY */
.empty-zone{display:flex;flex-direction:column;align-items:center;justify-content:center;height:140px;color:var(--muted);font-size:13px;gap:8px;width:100%}
.empty-zone .ei{font-size:36px;opacity:.3}

/* LOADING */
.loading-overlay{position:fixed;inset:0;background:rgba(7,9,13,.95);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;z-index:500;transition:opacity .4s}
.spinner{width:40px;height:40px;border-radius:50%;border:3px solid var(--border);border-top-color:var(--accent);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* CONFIRM MODAL */
.confirm-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);z-index:600;align-items:center;justify-content:center}
.confirm-modal.show{display:flex}
.confirm-box{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:32px;width:330px;text-align:center;animation:popIn .25s cubic-bezier(.34,1.56,.64,1)}
@keyframes popIn{from{transform:scale(.85);opacity:0}to{transform:scale(1);opacity:1}}
.cf-icon{font-size:52px;margin-bottom:12px}
.cf-title{font-size:18px;font-weight:700;margin-bottom:8px}
.cf-sub{font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.55}
.cf-actions{display:flex;gap:10px}
.cf-actions button{flex:1;padding:12px;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s}
.btn-cancel-cf{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-cancel-cf:hover{border-color:var(--muted);color:var(--text)}
.btn-ok-cf{border:none;color:#000;font-weight:800}
.btn-ok-cf.green{background:var(--green)}.btn-ok-cf.red{background:var(--red)}
.btn-ok-cf:hover{filter:brightness(1.1)}

/* TOAST */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 22px;font-size:13px;box-shadow:0 8px 32px rgba(0,0,0,0.5);opacity:0;transition:all .3s;z-index:700;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

@media(max-width:860px){.board{grid-template-columns:1fr}.stats-bar{flex-wrap:wrap}.stat{min-width:33%}}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="logo-chip">CW</div>
    <div class="page-title">PIZARRA DEL LOCAL</div>
  </div>
  <div class="topbar-right">
    <div class="status-pill">
      <div class="pulse-dot"></div>
      <span id="lastUpdate">Cargando...</span>
    </div>
    <button class="topbar-btn" onclick="loadData()">‚Üª Actualizar</button>
    <a class="back-btn" href="index.html">‚Üê Men√∫</a>
  </div>
</div>

<div class="stats-bar">
  <div class="stat"><div class="stat-ico">üöø</div><div><div class="stat-val" style="color:#4fc3f7" id="cnt-proceso">0</div><div class="stat-lbl">En proceso</div></div></div>
  <div class="stat"><div class="stat-ico">‚úÖ</div><div><div class="stat-val" style="color:var(--green)" id="cnt-terminado">0</div><div class="stat-lbl">Terminados</div></div></div>
  <div class="stat"><div class="stat-ico">üöó</div><div><div class="stat-val" style="color:var(--red)" id="cnt-retirado">0</div><div class="stat-lbl">Retirados hoy</div></div></div>
</div>

<div class="board">
  <div class="zone zone-proceso">
    <div class="zone-label"><span>üöø</span><span class="zone-title">EN PROCESO</span><span class="zone-count" id="lbl-proceso">0 carros</span></div>
    <div class="cars-grid" id="grid-proceso"></div>
  </div>
  <div class="zone zone-terminado">
    <div class="zone-label"><span>üÖøÔ∏è</span><span class="zone-title">TERMINADO</span><span class="zone-count" id="lbl-terminado">0 carros</span></div>
    <div class="cars-grid" id="grid-terminado"></div>
  </div>
  <div class="zone zone-retirado">
    <div class="zone-label"><span>üöóüí®</span><span class="zone-title">RETIRADO</span><span class="zone-count" id="lbl-retirado">0 carros</span></div>
    <div class="cars-grid" id="grid-retirado"></div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div style="font-size:14px;color:var(--muted);font-family:'DM Mono',monospace">Cargando pizarra...</div>
</div>

<div class="confirm-modal" id="confirmModal">
  <div class="confirm-box">
    <div class="cf-icon" id="cfIcon"></div>
    <div class="cf-title" id="cfTitle"></div>
    <div class="cf-sub" id="cfSub"></div>
    <div class="cf-actions">
      <button class="btn-cancel-cf" onclick="closeConfirm()">Cancelar</button>
      <button class="btn-ok-cf" id="cfOkBtn" onclick="confirmAction()"></button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê CONFIG ‚ïê‚ïê
const SHEET_ID   = "1VGBiKE8xOYRk22-EZFMGdXVPosUvXbHj-aeEOOQYzr4";
const SHEET_NAME = "Ordenes";
const COL = {placa:0,cliente:1,servicio:2,estado:3,hora:4};
const STATUS_MAP = {
  "en proceso":"proceso","lavando":"proceso","proceso":"proceso",
  "terminado":"terminado","listo":"terminado",
  "retirado":"retirado"
};

const CAR_COLORS=["#e53935","#1e88e5","#43a047","#fb8c00","#8e24aa","#00acc1","#f4511e","#3949ab","#00897b","#c0ca33","#6d4c41","#546e7a","#d81b60","#039be5","#7cb342"];
function carColor(p){let h=0;for(const c of(p||"CW"))h=(h*31+c.charCodeAt(0))%CAR_COLORS.length;return CAR_COLORS[Math.abs(h)]}

function carSVG(color,zone){
  const shine=zone==="terminado"?"#ffffff40":"#ffffff1a";
  const wet=zone==="proceso";const spark=zone==="terminado";
  return `<svg width="108" height="68" viewBox="0 0 108 68" fill="none" xmlns="http://www.w3.org/2000/svg" class="car-svg">
    <ellipse cx="54" cy="63" rx="41" ry="5.5" fill="rgba(0,0,0,0.38)"/>
    <rect x="9" y="21" width="90" height="35" rx="10" fill="${color}"/>
    <rect x="24" y="11" width="60" height="28" rx="8" fill="${color}" opacity=".87"/>
    <rect x="26" y="13" width="26" height="16" rx="3.5" fill="${shine}" stroke="rgba(255,255,255,0.18)" stroke-width="1"/>
    <rect x="56" y="13" width="26" height="16" rx="3.5" fill="${shine}" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
    <rect x="9" y="27" width="15" height="4" rx="2" fill="rgba(255,255,255,0.07)"/>
    <rect x="84" y="27" width="15" height="4" rx="2" fill="rgba(255,255,255,0.05)"/>
    <circle cx="27" cy="54" r="9.5" fill="#131622" stroke="#252535" stroke-width="1.5"/>
    <circle cx="27" cy="54" r="4.5" fill="#383850"/>
    <circle cx="81" cy="54" r="9.5" fill="#131622" stroke="#252535" stroke-width="1.5"/>
    <circle cx="81" cy="54" r="4.5" fill="#383850"/>
    <circle cx="27" cy="22" r="9.5" fill="#131622" stroke="#252535" stroke-width="1.5"/>
    <circle cx="27" cy="22" r="4.5" fill="#383850"/>
    <circle cx="81" cy="22" r="9.5" fill="#131622" stroke="#252535" stroke-width="1.5"/>
    <circle cx="81" cy="22" r="4.5" fill="#383850"/>
    <rect x="6" y="30" width="7" height="10" rx="2.5" fill="#fffde7" opacity=".9"/>
    <rect x="6" y="40" width="7" height="6" rx="1.5" fill="#ff7043" opacity=".65"/>
    <rect x="95" y="30" width="7" height="10" rx="2.5" fill="#ff5252" opacity=".85"/>
    <rect x="95" y="40" width="7" height="6" rx="1.5" fill="#ff5252" opacity=".55"/>
    ${wet?`<circle cx="40" cy="21" r="2.2" fill="#4fc3f7" opacity=".72"/>
    <circle cx="60" cy="15" r="1.6" fill="#4fc3f7" opacity=".52"/>
    <circle cx="74" cy="22" r="1.9" fill="#81d4fa" opacity=".6"/>
    <circle cx="50" cy="25" r="1.3" fill="#b3e5fc" opacity=".48"/>`:""}
    ${spark?`<text x="93" y="14" font-size="13" opacity=".9">‚ú®</text>`:""}
  </svg>`;
}

function makeDrops(){
  let h='<div class="wash-drops">';
  for(let i=0;i<8;i++){const ht=12+Math.random()*28;h+=`<div class="drop-p" style="left:${8+Math.random()*84}%;height:${ht}px;animation-duration:${.65+Math.random()*.95}s;animation-delay:${Math.random()*.85}s"></div>`;}
  return h+'</div>';
}

function timeAgo(ts){
  if(!ts)return "";
  try{const[h,m]=ts.split(":").map(Number);const now=new Date(),then=new Date(now);then.setHours(h,m,0,0);const diff=Math.round((now-then)/60000);if(diff<0||diff>720)return "";return diff<60?`${diff} min`:`${Math.floor(diff/60)}h ${diff%60}m`;}catch{return ""}
}

function esc(s){return(s||"").replace(/'/g,"\\'").replace(/"/g,"&quot;")}

let localState={};
function effectiveStatus(car){return localState[car.placa]||STATUS_MAP[(car.estado||"").toLowerCase().trim()]||null}

function buildCard(car,zone){
  const color=carColor(car.placa||"CW");
  const elapsed=timeAgo(car.hora);
  const urgent=elapsed&&parseInt(elapsed)>90;
  const warn=elapsed&&parseInt(elapsed)>45;
  const drops=zone==="proceso"?makeDrops():"";
  const badges={proceso:"badge-proceso",terminado:"badge-terminado",retirado:"badge-retirado"};
  const labels={proceso:"Lavando",terminado:"Listo ‚úì",retirado:"Retirado"};

  let actions="";
  if(zone==="proceso"){
    actions=`<div class="card-actions"><button class="btn-action btn-terminar" onclick="askChange('${esc(car.placa)}','${esc(car.cliente)}','terminado')">‚úÖ Marcar terminado</button></div>`;
  } else if(zone==="terminado"){
    actions=`<div class="card-actions">
      <button class="btn-action btn-avisar" onclick="notifyClient('${esc(car.placa)}','${esc(car.cliente)}')">üì≤ Avisar cliente</button>
      <button class="btn-action btn-retirar" onclick="askChange('${esc(car.placa)}','${esc(car.cliente)}','retirado')">üöó Marcar retirado</button>
    </div>`;
  }

  return `<div class="car-card">
    ${drops}
    <span class="car-badge ${badges[zone]}">${labels[zone]}</span>
    <div class="car-visual">${carSVG(color,zone)}</div>
    <div class="car-plate">${car.placa||"???"}</div>
    <div class="car-name">${car.cliente||"Cliente"}</div>
    <div class="car-service">${car.servicio||""}</div>
    ${elapsed?`<div class="car-time ${urgent?"urgent":warn?"warn":""}">${urgent?"‚ö†Ô∏è":"üïê"} ${elapsed}</div>`:""}
    ${actions}
  </div>`;
}

let pendingAction=null;
function askChange(placa,cliente,newStatus){
  pendingAction={placa,newStatus};
  const isT=newStatus==="terminado";
  document.getElementById("cfIcon").textContent=isT?"‚úÖ":"üöó";
  document.getElementById("cfTitle").textContent=isT?"¬øMarcar como terminado?":"¬øMarcar como retirado?";
  document.getElementById("cfSub").textContent=isT
    ?`El veh√≠culo de ${cliente} se mover√° al parqueo de listos.`
    :`El veh√≠culo de ${cliente} ser√° marcado como retirado.`;
  const btn=document.getElementById("cfOkBtn");
  btn.textContent=isT?"S√≠, terminado":"S√≠, retirado";
  btn.className="btn-ok-cf "+(isT?"green":"red");
  document.getElementById("confirmModal").classList.add("show");
}
function closeConfirm(){document.getElementById("confirmModal").classList.remove("show");pendingAction=null}
function confirmAction(){
  if(!pendingAction)return;
  const{placa,newStatus}=pendingAction;
  localState[placa]=newStatus;
  closeConfirm();
  showToast(newStatus==="terminado"?"‚úÖ Veh√≠culo marcado como terminado":"üöó Veh√≠culo retirado del local");
  renderAll();
}

function notifyClient(placa,cliente){showToast(`üì≤ Aviso enviado a ${cliente||placa}`)}

function showToast(msg,ms=3200){
  const t=document.getElementById("toast");t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),ms);
}

let allCars=[];
function renderAll(){
  const groups={proceso:[],terminado:[],retirado:[]};
  for(const car of allCars){const st=effectiveStatus(car);if(st&&groups[st])groups[st].push(car)}
  const empty={proceso:"Sin carros en lavado",terminado:"Parqueo vac√≠o",retirado:"Ning√∫n retiro a√∫n"};
  ["proceso","terminado","retirado"].forEach(z=>{
    const grid=document.getElementById("grid-"+z);
    const cars=groups[z];
    grid.innerHTML=cars.length?cars.map(c=>buildCard(c,z)).join(""):`<div class="empty-zone"><div class="ei">üöò</div>${empty[z]}</div>`;
    document.getElementById("cnt-"+z).textContent=cars.length;
    document.getElementById("lbl-"+z).textContent=cars.length+" carro"+(cars.length!==1?"s":"");
  });
}

async function fetchSheet(){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
  const r=await fetch(url,{cache:"no-store"});if(!r.ok)throw new Error("Sheet");
  return parseCSV(await r.text());
}
function parseCSV(text){
  return text.trim().split("\n").slice(1).map(line=>{
    const cols=[];let inQ=false,cur="";
    for(const ch of line+","){if(ch==='"'){inQ=!inQ}else if(ch===","&&!inQ){cols.push(cur.trim());cur=""}else cur+=ch;}
    return{placa:cols[COL.placa]||"",cliente:cols[COL.cliente]||"",servicio:cols[COL.servicio]||"",estado:(cols[COL.estado]||"").toLowerCase().trim(),hora:cols[COL.hora]||""};
  }).filter(r=>r.placa);
}

function demoData(){
  function ago(m){const d=new Date(Date.now()-m*60000);return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0")}
  return[
    {placa:"CRC-1234",cliente:"Juan Mora",servicio:"Lavado completo",estado:"en proceso",hora:ago(35)},
    {placa:"SJO-5678",cliente:"Ana Sol√≠s",servicio:"Encerado + lavado",estado:"en proceso",hora:ago(58)},
    {placa:"ALJ-9012",cliente:"Luis Brenes",servicio:"Detailing interior",estado:"en proceso",hora:ago(97)},
    {placa:"HER-3344",cliente:"Mar√≠a Quesada",servicio:"Lavado express",estado:"terminado",hora:ago(80)},
    {placa:"CAR-5566",cliente:"Carlos Vega",servicio:"Pulido completo",estado:"terminado",hora:ago(112)},
    {placa:"SJO-7788",cliente:"Diego Vargas",servicio:"Lavado express",estado:"retirado",hora:ago(150)},
  ];
}

async function loadData(){
  try{
    const data=await fetchSheet();
    if(!data.length)throw new Error("empty");
    allCars=data;
  }catch(e){
    console.warn("Demo:",e.message);
    allCars=demoData();
    showToast("‚ö†Ô∏è Modo demo ‚Äî publica tu Sheet para datos reales");
  }
  renderAll();
  document.getElementById("lastUpdate").textContent="Actualizado "+new Date().toLocaleTimeString("es-CR");
  const ov=document.getElementById("loadingOverlay");
  ov.style.opacity="0";setTimeout(()=>ov.style.display="none",400);
}

setInterval(loadData,45000);
loadData();
</script>
</body>
</html>
